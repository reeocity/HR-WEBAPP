generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model Staff {
  id             String   @id @default(cuid())
  staffId        String?  @unique @map("staff_id")
  fullName       String   @map("full_name")
  department     String
  position       String
  resumptionDate DateTime @map("resumption_date")
  status         String?  @map("status")
  phone          String?  @map("phone")
  bankDetails    String?  @map("bank_details")
  bankName       String?  @map("bank_name")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  createdById    String?  @map("created_by")

  guarantors     Guarantor[]
  salaryHistory  SalaryHistory[]
  latenessLogs   LatenessLog[]
  absenceLogs    AbsenceLog[]
  queryLogs      QueryLog[]
  manualDeductions ManualDeduction[]
  payrollLines   PayrollLine[]
}

model Guarantor {
  id          String   @id @default(cuid())
  staffId     String   @map("staff_id")
  slot        Int      @map("guarantor_slot")
  name        String   @map("name")
  phone       String?  @map("phone")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by")

  staff       Staff    @relation(fields: [staffId], references: [id])

  @@unique([staffId, slot], name: "staffId_slot")
}

model SalaryHistory {
  id            String   @id @default(cuid())
  staffId       String   @map("staff_id")
  monthlySalary Decimal  @db.Decimal(12, 2) @map("monthly_salary")
  effectiveFrom DateTime @map("effective_from")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  createdById   String?  @map("created_by")

  staff         Staff    @relation(fields: [staffId], references: [id])

  @@unique([staffId, effectiveFrom], name: "staffId_effectiveFrom")
}

model LatenessLog {
  id          String   @id @default(cuid())
  staffId     String   @map("staff_id")
  date        DateTime @map("date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by")

  staff       Staff    @relation(fields: [staffId], references: [id])

  @@unique([staffId, date], name: "staffId_date_late")
}

enum AbsenceType {
  PERMISSION
  NO_PERMISSION
}

model AbsenceLog {
  id          String      @id @default(cuid())
  staffId     String      @map("staff_id")
  date        DateTime    @map("date")
  type        AbsenceType @map("type")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  createdById String?     @map("created_by")

  staff       Staff       @relation(fields: [staffId], references: [id])

  @@unique([staffId, date], name: "staffId_date_abs")
}

model QueryLog {
  id             String   @id @default(cuid())
  staffId        String   @map("staff_id")
  date           DateTime @map("date")
  reason         String   @map("reason")
  surchargeAmount Decimal? @db.Decimal(12, 2) @map("surcharge_amount")
  penaltyDays    Int?     @map("penalty_days")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  createdById    String?  @map("created_by")

  staff          Staff    @relation(fields: [staffId], references: [id])
}

enum ManualDeductionCategory {
  NEW_STAFF_STATUTORY_DEDUCTION
  ABSENCE_LATENESS_PERMISSION
  CITY_LEDGER_QUERY
  STAFF_MEAL_TICKET
  CONTROL_DEBT
  STAFF_RENT
  BANK_CHARGES
  OLD_STATUTORY_DEDUCTION
  PAYEE
  DEBT_DEDUCT
  MEETING_DEBIT
  CLEANING_DEBIT
  OTHER
}

model ManualDeduction {
  id          String                  @id @default(cuid())
  staffId     String                  @map("staff_id")
  month       Int                     @map("month")
  year        Int                     @map("year")
  category    ManualDeductionCategory @map("category")
  amount      Decimal                 @db.Decimal(12, 2) @map("amount")
  note        String?                 @map("note")
  createdAt   DateTime                @default(now()) @map("created_at")
  updatedAt   DateTime                @updatedAt @map("updated_at")
  createdById String?                 @map("created_by")

  staff       Staff                   @relation(fields: [staffId], references: [id])
}

enum PayrollStatus {
  DRAFT
  APPROVED
  PAID
}

model PayrollRun {
  id          String        @id @default(cuid())
  month       Int           @map("month")
  year        Int           @map("year")
  status      PayrollStatus @map("status")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  createdById String?       @map("created_by")

  payrollLines PayrollLine[]

  @@unique([month, year], name: "payroll_month_year")
}

enum PayrollPaymentStatus {
  UNPAID
  PAID
}

model PayrollLine {
  id             String               @id @default(cuid())
  payrollRunId   String               @map("payroll_run_id")
  staffId        String               @map("staff_id")
  baseSalary     Decimal              @db.Decimal(12, 2) @map("base_salary")
  dailyRate      Decimal              @db.Decimal(12, 2) @map("daily_rate")
  totalDeductions Decimal             @db.Decimal(12, 2) @map("total_deductions")
  netPay         Decimal              @db.Decimal(12, 2) @map("net_pay")
  paymentStatus  PayrollPaymentStatus @map("payment_status")
  paidAt         DateTime?            @map("paid_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  payrollRun     PayrollRun           @relation(fields: [payrollRunId], references: [id])
  staff          Staff                @relation(fields: [staffId], references: [id])
  deductionLines PayrollDeductionLine[]
}

enum PayrollDeductionType {
  LATENESS
  ABSENCE
  QUERY
  MANUAL
  NEW_STAFF_STATUTORY
  OTHER
}

model PayrollDeductionLine {
  id            String               @id @default(cuid())
  payrollLineId String               @map("payroll_line_id")
  type          PayrollDeductionType @map("type")
  amount        Decimal              @db.Decimal(12, 2) @map("amount")
  note          String?              @map("note")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  payrollLine   PayrollLine          @relation(fields: [payrollLineId], references: [id])
}
